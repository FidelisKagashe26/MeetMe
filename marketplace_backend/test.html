<!doctype html>
<html lang="sw">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WS Test - Marketplace Chat</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial; margin: 18px; background:#f7fafc; color:#111827; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:16px; max-width:900px; margin:0 auto; box-shadow:0 2px 6px rgba(0,0,0,0.04); }
    label{ display:block; font-size:13px; margin-top:8px; color:#374151; }
    input[type="text"], textarea { width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; margin-top:6px; font-family: monospace; }
    textarea { min-height:64px; resize:vertical; }
    button { margin-top:10px; padding:8px 12px; border-radius:6px; border:0; background:#0ea5a4; color:white; cursor:pointer; }
    button.secondary { background:#64748b; }
    #status { margin-left:10px; font-weight:600; }
    #messages { margin-top:12px; background:#0f172a; color:#e6eef4; min-height:200px; padding:12px; border-radius:6px; overflow:auto; font-family:monospace; white-space:pre-wrap; }
    .msg-meta { color:#9ca3af; font-size:12px; margin-bottom:6px; }
    .controls { display:flex; gap:8px; margin-top:8px; }
    .controls > * { flex:1; }
  </style>
</head>
<body>
  <div class="card">
    <h2>WebSocket Chat Tester</h2>
    <p>Tumia fomu hii kujaribu WebSocket endpoint yako (channel ya chat).</p>

    <label>Server (host + scheme)</label>
    <input id="server" type="text" value="ws://127.0.0.1:8000" />

    <label>Conversation ID</label>
    <input id="conversationId" type="text" value="1" />

    <label>Token (bearer / JWT)</label>
    <textarea id="token">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzY0MzI0OTU3LCJpYXQiOjE3NjQzMjQwNTcsImp0aSI6IjY2NTZhNWZmNDNiYTQxYmRhNTdjMGMwYjI1MTk4MzBiIiwidXNlcl9pZCI6IjEifQ.WaXRvVc1BEDlQEXDAyrGBXmaivLLkqI7f1WzA105_Ic</textarea>

    <div style="margin-top:8px;">
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" class="secondary">Disconnect</button>
      <span id="status">Disconnected</span>
    </div>

    <label style="margin-top:12px;">Send JSON message</label>
    <textarea id="outgoing">{"type":"message","text":"Hello from tester"} </textarea>
    <div class="controls">
      <button id="sendBtn">Send</button>
      <button id="sendTypingBtn" class="secondary">Send typing=true</button>
    </div>

    <label style="margin-top:12px;">Incoming messages</label>
    <div id="messages">-- no messages yet --</div>
  </div>

  <script>
    let ws = null;
    const serverEl = document.getElementById('server');
    const convEl = document.getElementById('conversationId');
    const tokenEl = document.getElementById('token');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const sendBtn = document.getElementById('sendBtn');
    const sendTypingBtn = document.getElementById('sendTypingBtn');
    const outgoingEl = document.getElementById('outgoing');
    const messagesEl = document.getElementById('messages');
    const statusEl = document.getElementById('status');

    function appendMsg(kind, text) {
      const time = new Date().toLocaleTimeString();
      const meta = document.createElement('div');
      meta.className = 'msg-meta';
      meta.textContent = `[${time}] ${kind}`;
      const body = document.createElement('div');
      body.textContent = text;
      messagesEl.appendChild(meta);
      messagesEl.appendChild(body);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setStatus(s) {
      statusEl.textContent = s;
    }

    function connect() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        appendMsg('info','Already connected');
        return;
      }
      const server = serverEl.value.trim().replace(/\/$/, ''); 
      const conversationId = convEl.value.trim();
      const token = encodeURIComponent(tokenEl.value.trim());

      if (!server || !conversationId || !token) {
        appendMsg('error', 'Server, conversationId and token are required.');
        return;
      }

      const url = `${server}/ws/chat/${conversationId}/?token=${token}`;
      appendMsg('info', `Connecting to ${url}`);
      setStatus('Connecting...');
      try {
        ws = new WebSocket(url);
      } catch (err) {
        appendMsg('error', 'Failed to create WebSocket: ' + err.message);
        setStatus('Disconnected');
        return;
      }

      ws.onopen = () => {
        appendMsg('connection', 'WebSocket connected');
        setStatus('Connected');
        try {
          ws.send(JSON.stringify({ type: "typing", is_typing: true }));
          appendMsg('sent', JSON.stringify({ type: "typing", is_typing: true }));
        } catch (err) {
          appendMsg('error', 'Failed to send typing: ' + err.message);
        }
      };

      ws.onmessage = (e) => {
        let received = e.data;
        try {
          const parsed = JSON.parse(e.data);
          received = JSON.stringify(parsed, null, 2);
        } catch (_) { /* not json */ }
        appendMsg('received', received);
      };

      ws.onerror = (err) => {
        appendMsg('error', 'WebSocket error (see console)');
        console.error('WS error', err);
      };

      ws.onclose = (ev) => {
        appendMsg('connection', `Closed (code=${ev.code}, reason=${ev.reason || 'n/a'})`);
        setStatus('Disconnected');
        ws = null;
      };
    }

    function disconnect() {
      if (!ws) {
        appendMsg('info', 'Not connected');
        return;
      }
      ws.close(1000, 'Client disconnect');
      appendMsg('info', 'Closing connection...');
    }

    connectBtn.addEventListener('click', connect);
    disconnectBtn.addEventListener('click', disconnect);

    sendBtn.addEventListener('click', () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        appendMsg('error', 'WebSocket not connected');
        return;
      }
      const raw = outgoingEl.value.trim();
      try {
        const obj = JSON.parse(raw);
        ws.send(JSON.stringify(obj));
        appendMsg('sent', JSON.stringify(obj));
      } catch (err) {
        appendMsg('error', 'Invalid JSON: ' + err.message);
      }
    });

    sendTypingBtn.addEventListener('click', () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        appendMsg('error', 'WebSocket not connected');
        return;
      }
      try {
        const msg = { type: "typing", is_typing: true };
        ws.send(JSON.stringify(msg));
        appendMsg('sent', JSON.stringify(msg));
      } catch (err) {
        appendMsg('error', 'Send typing failed: ' + err.message);
      }
    });
  </script>
</body>
</html>
